# 功能规格说明

## 宪法检查

本规格说明必须符合项目宪法要求：

- ✅ **模块化**: 功能归属 `atlas-common-infra-logging` 模块
- ✅ **代码复用**: 提供可复用的日志配置和工具类
- ✅ **中文注释**: 所有代码使用中文注释
- ✅ **配置文件格式**: 使用 YAML 格式（日志配置使用 XML，符合 Logback 规范）

## 功能描述

实现 `atlas-common-infra-logging` 模块，提供项目日志基础设施功能，包括 Logback 日志配置规范、TraceId 自动注入和管理、敏感信息脱敏工具等。该模块为所有业务模块提供统一的日志格式、链路追踪支持和数据脱敏能力，确保日志输出的规范性、可追溯性和安全性。

## 功能需求

### FR1: Logback 日志配置规范

**需求描述**: 提供标准的 Logback 日志配置模板和规范，确保所有模块使用统一的日志格式和输出策略。

**功能要求**:
- 提供标准的 logback-spring.xml 配置模板
- 定义统一的日志格式（包含时间戳、线程、级别、Logger、TraceId、消息）
- 支持控制台和文件输出
- 支持日志文件轮转（按时间和大小）
- 支持不同环境的日志级别配置（dev、test、prod）
- 支持错误日志单独输出
- 配置包含完整的中文注释

**验收标准**:
- 所有模块可以使用统一的日志配置模板
- 日志格式符合项目规范（包含 TraceId）
- 日志文件可以正确轮转
- 不同环境可以配置不同的日志级别
- 错误日志可以单独输出到指定文件
- 配置模板包含完整的中文注释

### FR2: TraceId 自动注入和管理

**需求描述**: 提供 TraceId 的自动注入、传递和管理功能，支持分布式链路追踪。

**功能要求**:
- 提供 TraceId 生成工具（支持 UUID 和雪花算法）
- 提供 TraceId 的 ThreadLocal 存储和管理
- 提供 HTTP 请求拦截器，自动从请求头获取或生成 TraceId
- 提供 Feign 拦截器，自动传递 TraceId 到下游服务
- 提供异步任务 TraceId 传递支持
- TraceId 自动注入到 MDC（Mapped Diagnostic Context）供日志使用
- 提供 TraceId 清理机制，避免内存泄漏

**验收标准**:
- HTTP 请求可以自动获取或生成 TraceId
- TraceId 可以正确传递到下游服务
- TraceId 可以正确传递到异步任务
- TraceId 可以正确输出到日志中
- TraceId 在请求结束后可以正确清理
- 支持手动设置和获取 TraceId

### FR3: 敏感信息脱敏工具

**需求描述**: 提供敏感信息脱敏工具类，支持常见敏感字段的自动脱敏，防止敏感信息泄露到日志中。

**功能要求**:
- 提供脱敏工具类，支持常见敏感字段脱敏（手机号、身份证号、银行卡号、邮箱、密码等）
- 支持自定义脱敏规则
- 支持对象字段自动脱敏（通过注解或配置）
- 提供日志脱敏拦截器，自动对日志消息中的敏感信息进行脱敏
- 支持脱敏规则的配置化
- 脱敏工具包含完整的中文注释

**验收标准**:
- 可以脱敏常见敏感字段（手机号、身份证号、银行卡号、邮箱、密码等）
- 可以自定义脱敏规则
- 可以自动对对象字段进行脱敏
- 日志消息中的敏感信息可以自动脱敏
- 脱敏规则可以配置化
- 脱敏工具包含完整的中文注释

## 用户场景

### 场景 1: 开发人员使用标准日志配置

**角色**: 后端开发人员

**前置条件**: 开发人员正在创建新的业务模块

**操作流程**:
1. 开发人员在模块的 `src/main/resources` 目录下复制 logback-spring.xml 配置模板
2. 根据模块需求调整日志级别和输出路径
3. 启动应用，日志自动按照标准格式输出

**预期结果**: 新模块的日志格式与项目其他模块保持一致，包含 TraceId，便于问题排查

### 场景 2: 系统自动生成和传递 TraceId

**角色**: 系统运维人员

**前置条件**: 用户发起 HTTP 请求

**操作流程**:
1. 用户发起 HTTP 请求，请求头中包含 TraceId（可选）
2. 系统自动从请求头获取 TraceId，如果没有则自动生成
3. TraceId 注入到 MDC 和 ThreadLocal
4. 请求处理过程中的所有日志自动包含 TraceId
5. 如果调用下游服务，TraceId 自动传递到下游服务
6. 请求结束后，TraceId 自动清理

**预期结果**: 一次请求的所有日志都包含相同的 TraceId，可以快速追踪完整的调用链

### 场景 3: 开发人员使用脱敏工具保护敏感信息

**角色**: 后端开发人员

**前置条件**: 开发人员需要记录包含敏感信息的日志

**操作流程**:
1. 开发人员在代码中调用脱敏工具类的方法
2. 传入敏感信息（如手机号、身份证号等）
3. 脱敏工具自动对敏感信息进行脱敏处理
4. 脱敏后的信息输出到日志

**预期结果**: 日志中的敏感信息被正确脱敏，保护用户隐私，符合安全规范

### 场景 4: 系统自动对日志消息进行脱敏

**角色**: 系统

**前置条件**: 日志消息中包含敏感信息

**操作流程**:
1. 日志消息输出前，经过脱敏拦截器
2. 脱敏拦截器检测日志消息中的敏感信息模式
3. 自动对检测到的敏感信息进行脱敏
4. 脱敏后的日志消息输出到日志文件

**预期结果**: 即使开发人员忘记手动脱敏，系统也能自动保护敏感信息

## 数据模型

### TraceId 管理

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| traceId | String | 链路追踪ID | 是 |
| threadLocal | ThreadLocal<String> | 线程本地存储 | 是 |
| mdcKey | String | MDC 键名（固定为 "traceId"） | 是 |

### 脱敏规则配置

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| fieldType | String | 字段类型（phone、idCard、bankCard、email、password等） | 是 |
| pattern | String | 匹配模式（正则表达式） | 是 |
| replacement | String | 替换规则 | 是 |
| prefixLength | Integer | 保留前缀长度 | 否 |
| suffixLength | Integer | 保留后缀长度 | 否 |

### 日志配置参数

| 参数名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| logFormat | String | 日志格式模板 | 是 |
| logLevel | String | 日志级别（DEBUG、INFO、WARN、ERROR） | 是 |
| logPath | String | 日志文件路径 | 是 |
| maxFileSize | String | 单个日志文件最大大小 | 是 |
| maxHistory | Integer | 日志文件保留天数 | 是 |

## 业务逻辑

### TraceId 生成逻辑

1. **生成时机**:
   - HTTP 请求到达时，如果请求头中没有 TraceId，则自动生成
   - 异步任务启动时，从父线程继承或生成新的 TraceId

2. **生成策略**:
   - 优先使用 UUID（32位，去除连字符）
   - 可选使用雪花算法生成的 ID
   - TraceId 长度建议 16-32 个字符

3. **传递逻辑**:
   - HTTP 请求：通过请求头 `X-Trace-Id` 传递
   - Feign 调用：通过 Feign 拦截器自动添加到请求头
   - 异步任务：通过 ThreadLocal 传递或继承父线程的 TraceId

### 脱敏处理逻辑

1. **脱敏规则**:
   - 手机号：保留前 3 位和后 4 位，中间用 `****` 替代（如：138****5678）
   - 身份证号：保留前 6 位和后 4 位，中间用 `****` 替代
   - 银行卡号：保留后 4 位，前面用 `****` 替代
   - 邮箱：保留用户名前 2 位和域名，中间用 `****` 替代（如：ab****@example.com）
   - 密码：全部替换为 `******`

2. **自动脱敏**:
   - 日志拦截器检测日志消息中的敏感信息模式
   - 使用正则表达式匹配敏感信息
   - 自动应用脱敏规则进行替换

## 异常处理

### 异常类型

1. **TraceId 生成失败**: TraceId 生成器异常时，使用备用方案或记录警告日志
2. **脱敏规则匹配失败**: 脱敏规则无法匹配时，记录警告日志但不影响日志输出
3. **日志配置加载失败**: 日志配置文件格式错误时，使用默认配置并记录错误

### 异常处理策略

- TraceId 生成失败时，使用 UUID 作为备用方案
- 脱敏失败时，记录警告日志但继续输出原始日志
- 日志配置错误时，使用 Spring Boot 默认配置

## 测试要求

- 单元测试覆盖率 ≥ 80%
- 测试 TraceId 的生成、传递和清理
- 测试脱敏工具的各种脱敏规则
- 测试日志配置的正确性
- 测试日志格式的输出

## 成功标准

1. **统一性**: 所有模块使用统一的日志格式，日志格式一致性达到 100%
2. **可追溯性**: TraceId 在请求链路中的传递成功率 ≥ 99%
3. **安全性**: 敏感信息脱敏覆盖率 ≥ 95%，日志中不应出现未脱敏的敏感信息
4. **易用性**: 开发人员可以在 10 分钟内配置和使用日志功能
5. **完整性**: 所有功能需求实现完成，单元测试覆盖率 ≥ 80%
6. **规范性**: 所有代码符合项目规范，中文注释覆盖率 100%

## 依赖关系

### 内部依赖

- 依赖父 POM（atlas）的版本管理
- 依赖日志格式规范文档的定义

### 外部依赖

- Logback（日志框架，Spring Boot 内置）
- SLF4J（日志门面，Spring Boot 内置）
- Spring Boot Web（用于 HTTP 拦截器）
- Spring Cloud OpenFeign（用于 Feign 拦截器，可选）

## 假设

1. 所有业务模块都会使用统一的日志配置
2. TraceId 通过 HTTP 请求头传递
3. 敏感信息脱敏规则符合项目安全规范
4. 日志文件存储在应用服务器的本地文件系统
5. 日志格式规范文档已定义并稳定

## 实现注意事项

- [ ] 确保日志配置模板符合项目日志格式规范
- [ ] 确保 TraceId 的线程安全性
- [ ] 确保 TraceId 在请求结束后正确清理，避免内存泄漏
- [ ] 确保脱敏规则的准确性和性能
- [ ] 确保所有类和方法添加中文注释
- [ ] 遵循包名规范：`com.atlas.common.infra.logging`
- [ ] 日志配置支持环境变量和配置文件动态配置
- [ ] 创建模块 README.md 文档，符合项目宪法要求

## Clarifications

### Session 2026-01-27

- Q: 是否需要创建模块 README.md 文档？ → A: 是，根据项目宪法要求，每个模块必须在根目录下提供 README.md 文件

