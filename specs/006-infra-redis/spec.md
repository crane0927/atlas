# 功能规格说明

## 宪法检查

本规格说明必须符合项目宪法要求：

- ✅ **RESTful API**: 不涉及 RESTful API（基础设施模块）
- ✅ **中文注释**: 所有代码使用中文注释
- ✅ **代码复用**: 识别并复用现有公共方法
- ✅ **模块化**: 功能归属正确的模块

## 功能描述

实现 `atlas-common-infra-redis` 模块，为项目提供统一的 Redis 基础设施支持。该模块包含 Redis 序列化配置、Key 命名规范管理和基础缓存工具类，确保所有业务模块使用一致的 Redis 操作方式和缓存策略。

### 核心功能

1. **Redis 序列化配置**
   - 提供统一的 Redis 序列化器配置（JSON 格式）
   - 支持自定义序列化策略
   - 确保序列化格式与项目其他模块一致（如 Jackson 配置）

2. **Key 规范管理**
   - 定义统一的 Redis Key 命名规范
   - 提供 Key 生成工具类，自动应用命名规范
   - 支持 Key 前缀管理（模块前缀、业务前缀等）
   - 支持 Key 过期时间管理

3. **基础缓存工具**
   - 提供通用的缓存操作工具类
   - 支持字符串、对象、列表、集合、哈希等常用数据结构操作
   - 支持缓存过期时间设置
   - 支持缓存穿透、缓存击穿、缓存雪崩的防护机制

## 用户场景

### 场景 1: 配置 Redis 序列化

**作为** 开发人员  
**我希望** 在项目中统一配置 Redis 序列化方式  
**以便** 确保所有模块使用一致的序列化格式，避免序列化/反序列化问题

**验收标准**:
- 可以通过配置类统一设置 Redis 序列化器
- 序列化格式与项目 Jackson 配置保持一致
- 支持自定义序列化策略

### 场景 2: 使用统一的 Key 命名规范

**作为** 开发人员  
**我希望** 使用统一的 Redis Key 命名规范  
**以便** 避免 Key 冲突，便于管理和监控

**验收标准**:
- 可以通过工具类生成符合规范的 Key
- Key 格式包含模块前缀、业务前缀等信息
- 支持 Key 过期时间设置

### 场景 3: 使用基础缓存工具进行缓存操作

**作为** 开发人员  
**我希望** 使用封装好的缓存工具类进行缓存操作  
**以便** 简化缓存操作代码，提高开发效率

**验收标准**:
- 可以方便地进行字符串、对象、列表等数据结构的缓存操作
- 支持设置缓存过期时间
- 支持缓存穿透、击穿、雪崩的防护

## 功能需求

### FR1: Redis 序列化配置

**描述**: 提供统一的 Redis 序列化配置，确保所有模块使用一致的序列化格式。

**详细需求**:
- FR1.1: 提供 Redis 序列化配置类，支持 JSON 序列化
- FR1.2: 序列化格式与项目 Jackson 配置保持一致（日期格式、Long 转 String 等）
- FR1.3: 支持自定义序列化器配置
- FR1.4: 支持 String、Hash、List、Set、ZSet 等数据结构的序列化配置

**验收标准**:
- 可以通过配置类统一设置 Redis 序列化器
- 序列化后的数据格式符合项目规范
- 支持反序列化，数据完整性正确

### FR2: Key 规范管理

**描述**: 定义统一的 Redis Key 命名规范，提供 Key 生成工具类。

**详细需求**:
- FR2.1: 定义 Key 命名规范格式（如：`模块:业务:标识符`）
- FR2.2: 提供 Key 生成工具类，自动应用命名规范
- FR2.3: 支持模块前缀配置
- FR2.4: 支持业务前缀配置
- FR2.5: 支持 Key 过期时间管理
- FR2.6: 提供 Key 模式匹配工具（支持通配符查询）

**验收标准**:
- 生成的 Key 符合命名规范
- Key 格式清晰，便于识别和管理
- 支持 Key 过期时间设置和查询

### FR3: 基础缓存工具

**描述**: 提供通用的缓存操作工具类，封装常用的缓存操作。

**详细需求**:
- FR3.1: 提供字符串缓存操作（get、set、delete、exists 等）
- FR3.2: 提供对象缓存操作（支持自动序列化/反序列化）
- FR3.3: 提供列表缓存操作（lpush、rpush、lrange、lpop、rpop 等）
- FR3.4: 提供集合缓存操作（sadd、srem、smembers、sismember 等）
- FR3.5: 提供哈希缓存操作（hset、hget、hgetAll、hdel 等）
- FR3.6: 支持缓存过期时间设置
- FR3.7: 支持缓存穿透防护（空值缓存）
- FR3.8: 支持缓存击穿防护（分布式锁）
- FR3.9: 支持缓存雪崩防护（过期时间随机化）

**验收标准**:
- 可以方便地进行各种数据结构的缓存操作
- 缓存操作代码简洁，易于使用
- 防护机制有效，避免常见缓存问题

## 非功能需求

### NFR1: 性能要求

- 缓存操作响应时间 ≤ 10ms（本地 Redis）
- 支持高并发访问（≥ 1000 QPS）
- 序列化/反序列化性能满足业务需求

### NFR2: 可靠性要求

- 缓存操作异常不影响主业务流程
- 提供异常处理和降级机制
- 支持 Redis 连接池配置

### NFR3: 可维护性要求

- 代码结构清晰，易于理解和维护
- 提供完整的文档和使用示例
- 支持配置灵活调整

### NFR4: 兼容性要求

- 兼容 Spring Boot 4.0.1
- 兼容 Spring Data Redis 3.x
- 兼容 Redis 6.0+

## 数据模型

### RedisKey（Key 规范类）

**描述**: Redis Key 规范管理类，用于生成符合规范的 Key。

**字段定义**:

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| modulePrefix | String | 模块前缀 | 是 |
| businessPrefix | String | 业务前缀 | 否 |
| identifier | String | 标识符 | 是 |
| expireSeconds | Long | 过期时间（秒） | 否 |

**约束规则**:
- Key 格式：`{modulePrefix}:{businessPrefix}:{identifier}`（businessPrefix 可选）
- 各组成部分使用冒号分隔
- 支持过期时间设置

### CacheConfig（缓存配置类）

**描述**: Redis 缓存配置类，包含序列化配置和连接配置。

**配置项**:

| 配置项 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| serializer | RedisSerializer | 序列化器 | Jackson2JsonRedisSerializer |
| keySerializer | RedisSerializer | Key 序列化器 | StringRedisSerializer |
| connectionFactory | RedisConnectionFactory | 连接工厂 | LettuceConnectionFactory |
| defaultExpireSeconds | Long | 默认过期时间（秒） | 3600 |

## 业务逻辑

### Key 生成逻辑

1. 根据模块前缀、业务前缀和标识符生成 Key
2. 如果业务前缀为空，则格式为：`{modulePrefix}:{identifier}`
3. 如果业务前缀不为空，则格式为：`{modulePrefix}:{businessPrefix}:{identifier}`
4. 支持设置 Key 过期时间

### 缓存操作逻辑

1. **字符串缓存**:
   - set: 设置字符串值，支持过期时间
   - get: 获取字符串值
   - delete: 删除 Key
   - exists: 检查 Key 是否存在

2. **对象缓存**:
   - set: 序列化对象后存储，支持过期时间
   - get: 获取并反序列化对象
   - 自动处理序列化/反序列化

3. **列表缓存**:
   - 支持左/右推入元素
   - 支持左/右弹出元素
   - 支持范围查询
   - 支持列表长度查询

4. **集合缓存**:
   - 支持添加/删除元素
   - 支持查询所有元素
   - 支持判断元素是否存在
   - 支持集合运算（交集、并集、差集）

5. **哈希缓存**:
   - 支持设置/获取字段值
   - 支持获取所有字段
   - 支持删除字段
   - 支持字段存在性检查

### 缓存防护逻辑

1. **缓存穿透防护**:
   - 查询不存在的数据时，缓存空值
   - 空值缓存设置较短的过期时间
   - 避免频繁查询数据库

2. **缓存击穿防护**:
   - 使用分布式锁防止热点 Key 失效时大量请求穿透到数据库
   - 锁超时时间可配置
   - 支持锁续期机制

3. **缓存雪崩防护**:
   - 缓存过期时间添加随机值
   - 避免大量 Key 同时过期
   - 随机值范围可配置

## 异常处理

### 异常类型

1. **Redis 连接异常**: Redis 连接失败或超时
   - 处理方式: 记录日志，返回默认值或抛出业务异常
   - 降级策略: 直接查询数据库，不依赖缓存

2. **序列化异常**: 对象序列化/反序列化失败
   - 处理方式: 记录日志，抛出异常
   - 降级策略: 使用字符串序列化作为备选方案

3. **Key 格式异常**: Key 不符合命名规范
   - 处理方式: 记录警告日志，使用默认格式
   - 降级策略: 自动修正 Key 格式

## 依赖关系

### 模块依赖

- **spring-boot-starter-data-redis**: Spring Data Redis 支持
- **atlas-common-infra-web**: 依赖 Jackson 配置（序列化格式一致性）

### 外部依赖

- **Redis**: Redis 服务器（6.0+）
- **Lettuce**: Redis 客户端（Spring Boot 内置）

## 测试要求

- 单元测试覆盖率 ≥ 80%
- 集成测试覆盖主要缓存操作场景
- 测试缓存防护机制的有效性
- 测试序列化/反序列化的正确性
- 测试 Key 规范的正确性

## 成功标准

1. **统一性**: 所有模块使用统一的 Redis 序列化配置，序列化格式一致性达到 100%
2. **规范性**: 所有 Redis Key 符合命名规范，Key 规范遵循率达到 100%
3. **易用性**: 开发人员可以在 5 分钟内理解并使用缓存工具类，无需深入了解 Redis 细节
4. **可靠性**: 缓存操作异常不影响主业务流程，异常处理覆盖率达到 100%
5. **性能**: 缓存操作响应时间 ≤ 10ms，满足高并发访问需求

## 实现注意事项

- [ ] 检查是否有可复用的公共方法（如 Jackson 配置）
- [ ] 确保所有类和方法添加中文注释
- [ ] 遵循项目代码规范和命名规范
- [ ] 使用统一的异常处理机制
- [ ] 提供完整的使用文档和示例代码
- [ ] 考虑与现有模块的集成（如 TraceId 支持）
