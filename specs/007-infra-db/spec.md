# 功能规格说明

## 宪法检查

本规格说明必须符合项目宪法要求：

- ✅ **RESTful API**: 基础设施模块，不涉及外部 API 接口
- ✅ **中文注释**: 所有代码使用中文注释
- ✅ **代码复用**: 识别并复用现有公共方法和工具类
- ✅ **模块化**: 功能归属正确的模块（atlas-common-infra-db）

## 功能描述

实现 `atlas-common-infra-db` 模块，为 Atlas 项目提供统一的数据库访问基础设施，包括 MyBatis-Plus 基础配置、分页插件、审计字段填充等功能。该模块为所有业务模块提供统一的数据库访问规范，确保数据访问的一致性、可维护性和可追溯性。

## 用户故事

### US1: MyBatis-Plus 基础配置

**作为** 开发人员  
**我希望** 使用统一的 MyBatis-Plus 配置  
**以便** 所有业务模块使用一致的数据库访问方式

**验收标准**:
- 提供统一的 MyBatis-Plus 配置类
- 配置类自动注册到 Spring 容器
- 支持通过配置文件自定义配置参数
- 配置类包含必要的 MyBatis-Plus 设置（如逻辑删除、字段策略等）

### US2: 分页插件

**作为** 开发人员  
**我希望** 使用统一的分页插件  
**以便** 简化分页查询的实现

**验收标准**:
- 提供分页插件配置（PaginationInterceptor）
- 支持自定义分页参数（页码、每页数量）
- 分页查询结果包含总记录数、当前页码、每页数量、总页数等信息
- 分页插件自动拦截分页查询，无需手动编写分页 SQL

### US3: 审计字段填充

**作为** 开发人员  
**我希望** 自动填充审计字段（创建时间、更新时间、创建人、更新人等）  
**以便** 简化数据审计字段的管理

**验收标准**:
- 提供审计字段填充处理器（MetaObjectHandler）
- 支持自动填充创建时间、更新时间
- 支持自动填充创建人、更新人（从安全上下文获取）
- 支持配置哪些字段需要自动填充
- 审计字段填充功能可以后置实现（标记为可选）

## 功能需求

### FR1: MyBatis-Plus 基础配置

**描述**: 提供统一的 MyBatis-Plus 配置类，包含必要的配置项。

**需求**:
- 创建 `MyBatisPlusConfig` 配置类
- 配置逻辑删除（可选，可后置实现）
- 配置字段策略（如插入时忽略 null 值、更新时忽略 null 值）
- 配置 ID 生成策略（可选，可后置实现）
- 支持通过配置文件自定义配置参数
- 配置类使用 `@Configuration` 注解，自动注册到 Spring 容器

**验收标准**:
- MyBatis-Plus 配置类可以正确创建
- 配置类自动注册到 Spring 容器
- 配置参数可以通过配置文件自定义
- 业务模块引入该模块后即可使用 MyBatis-Plus 功能

### FR2: 分页插件配置

**描述**: 提供统一的分页插件配置，简化分页查询的实现。

**需求**:
- 配置 `PaginationInterceptor` 分页插件
- 支持自定义分页参数（页码参数名、每页数量参数名、最大每页数量等）
- 分页查询结果包含完整的分页信息（总记录数、当前页码、每页数量、总页数）
- 分页插件自动拦截带有 `Page` 参数的方法
- 支持通过配置文件自定义分页参数

**验收标准**:
- 分页插件可以正确配置
- 分页查询可以正确执行
- 分页结果包含完整的分页信息
- 分页参数可以通过配置文件自定义

### FR3: 审计字段填充

**描述**: 提供审计字段自动填充功能，自动填充创建时间、更新时间、创建人、更新人等字段。

**需求**:
- 创建 `MetaObjectHandler` 实现类，处理字段自动填充
- 支持自动填充创建时间（`createTime`）和更新时间（`updateTime`）
- 支持自动填充创建人（`createBy`）和更新人（`updateBy`），从安全上下文获取当前用户信息
- 支持配置哪些字段需要自动填充（通过注解或配置）
- 审计字段填充功能可以后置实现（标记为可选，不影响 MVP）
- 提供审计字段注解（如 `@TableField(fill = FieldFill.INSERT)`）

**验收标准**:
- 插入数据时自动填充创建时间和创建人
- 更新数据时自动填充更新时间和更新人
- 审计字段填充功能可以正确工作
- 审计字段填充功能可以后置实现（不影响核心功能）

## 用户场景

### 场景 1: 使用 MyBatis-Plus 进行数据库操作

**前置条件**: 业务模块已引入 `atlas-common-infra-db` 模块

**步骤**:
1. 在业务模块中创建实体类，继承 `BaseEntity`（如果提供）
2. 创建 Mapper 接口，继承 `BaseMapper<T>`
3. 在 Service 中使用 Mapper 进行数据库操作

**预期结果**:
- 可以使用 MyBatis-Plus 提供的 CRUD 方法
- 数据库操作可以正确执行
- 配置的参数生效

### 场景 2: 使用分页插件进行分页查询

**前置条件**: 业务模块已引入 `atlas-common-infra-db` 模块

**步骤**:
1. 在 Service 方法中创建 `Page<T>` 对象
2. 调用 Mapper 的分页查询方法
3. 获取分页结果

**预期结果**:
- 分页查询可以正确执行
- 分页结果包含总记录数、当前页码、每页数量、总页数等信息
- 无需手动编写分页 SQL

### 场景 3: 使用审计字段填充

**前置条件**: 业务模块已引入 `atlas-common-infra-db` 模块，审计字段填充功能已实现

**步骤**:
1. 在实体类中定义审计字段（`createTime`、`updateTime`、`createBy`、`updateBy`）
2. 使用 `@TableField` 注解标记需要自动填充的字段
3. 执行插入或更新操作

**预期结果**:
- 插入数据时自动填充创建时间和创建人
- 更新数据时自动填充更新时间和更新人
- 审计字段值正确填充

## 数据模型

### MyBatisPlusConfig（MyBatis-Plus 配置类）

**描述**: MyBatis-Plus 基础配置类，提供统一的配置项。

**字段**:
- `logicDeleteValue`: 逻辑删除值（可选）
- `notLogicDeleteValue`: 非逻辑删除值（可选）
- `dbType`: 数据库类型（可选）
- `idType`: ID 生成策略（可选）

### PaginationInterceptor（分页插件）

**描述**: MyBatis-Plus 分页插件配置。

**配置参数**:
- `pageParam`: 页码参数名（默认：`page`）
- `sizeParam`: 每页数量参数名（默认：`size`）
- `maxLimit`: 最大每页数量（默认：1000）

### MetaObjectHandler（审计字段填充处理器）

**描述**: 审计字段自动填充处理器。

**处理的字段**:
- `createTime`: 创建时间（插入时填充）
- `updateTime`: 更新时间（插入和更新时填充）
- `createBy`: 创建人（插入时填充，从安全上下文获取）
- `updateBy`: 更新人（更新时填充，从安全上下文获取）

## 业务逻辑

### MyBatis-Plus 配置流程

1. 创建 `MyBatisPlusConfig` 配置类
2. 配置必要的 MyBatis-Plus 设置
3. 注册到 Spring 容器
4. 业务模块引入后自动生效

### 分页查询流程

1. Service 方法创建 `Page<T>` 对象
2. 调用 Mapper 的分页查询方法
3. 分页插件拦截查询，自动添加分页 SQL
4. 返回包含分页信息的结果

### 审计字段填充流程

1. 实体类定义审计字段
2. 使用注解标记需要自动填充的字段
3. 执行插入或更新操作
4. `MetaObjectHandler` 拦截操作，自动填充审计字段
5. 执行数据库操作

## 异常处理

### MyBatis-Plus 配置异常

- **场景**: 配置类创建失败或配置参数错误
- **处理**: 记录错误日志，抛出配置异常，阻止应用启动

### 分页查询异常

- **场景**: 分页参数无效或查询失败
- **处理**: 记录错误日志，返回空分页结果或抛出异常

### 审计字段填充异常

- **场景**: 安全上下文获取失败或字段填充失败
- **处理**: 记录警告日志，继续执行操作（不阻塞主流程）

## 依赖关系

### 模块依赖

- **mybatis-plus-boot-starter**: MyBatis-Plus 核心依赖
- **atlas-common-feature-security**: 安全模块（用于获取当前用户信息，可选）

### 内部依赖

- **atlas-common-feature-core**: 核心工具类（可选）

## 测试要求

- 单元测试覆盖率 ≥ 80%
- 测试 MyBatis-Plus 配置的正确性
- 测试分页插件的功能
- 测试审计字段填充的功能（如果实现）

## 成功标准

### 定量指标

- **配置正确性**: MyBatis-Plus 配置类可以正确创建并注册到 Spring 容器（100%）
- **分页功能**: 分页查询可以正确执行，分页结果包含完整信息（100%）
- **审计字段填充**: 如果实现，审计字段可以正确自动填充（100%）
- **测试覆盖率**: 单元测试覆盖率 ≥ 80%

### 定性指标

- **易用性**: 业务模块引入该模块后即可使用 MyBatis-Plus 功能，无需额外配置
- **一致性**: 所有业务模块使用统一的数据库访问规范
- **可维护性**: 配置集中管理，便于维护和扩展
- **可扩展性**: 支持通过配置文件自定义配置参数

## 假设和约束

### 假设

- 项目使用 MyBatis-Plus 作为 ORM 框架
- 项目使用 Spring Boot 作为应用框架
- 数据库支持标准 SQL 语法
- 审计字段填充功能可以后置实现（不影响 MVP）

### 约束

- 必须符合项目宪法要求（中文注释、模块化等）
- 必须与现有的基础设施模块（logging、web、redis）保持一致的设计风格
- 审计字段填充功能依赖安全模块（`atlas-common-feature-security`），如果安全模块未实现，审计字段填充功能可以后置实现

## 范围

### 包含

- MyBatis-Plus 基础配置
- 分页插件配置
- 审计字段填充功能（可后置实现）

### 不包含

- 数据库连接池配置（由 Spring Boot 自动配置）
- 数据库迁移工具（Flyway、Liquibase 等）
- 多数据源支持（后续迭代）
- 读写分离支持（后续迭代）

## 后续迭代

- 实现审计字段填充功能（如果 MVP 阶段未实现）
- 支持多数据源配置
- 支持读写分离
- 支持数据库连接池自定义配置
- 支持逻辑删除配置
- 支持 ID 生成策略配置
