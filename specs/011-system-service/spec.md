# 功能规格说明

## 宪法检查

本规格说明必须符合项目宪法要求：

- ✅ **RESTful API**: 所有接口遵循 RESTful 设计规范
- ✅ **中文注释**: 所有代码使用中文注释
- ✅ **代码复用**: 识别并复用现有公共方法
- ✅ **模块化**: 功能归属正确的模块
- ✅ **包结构规范**: 业务模块按业务再按技术分层组织（`com.atlas.system.user.controller`）
- ✅ **数据库技术**: 使用 PostgreSQL + MyBatis-Plus + Flyway/Liquibase
- ✅ **SQL 目录管理**: 在服务目录下建立 `sql` 目录，按版本管理 SQL 脚本

## 功能描述

实现 `atlas-system` 服务，提供用户、角色、权限管理的最小闭环功能，实现 `atlas-system-api` 中定义的接口契约，支持 `atlas-auth` 服务的用户认证和权限授权需求。

**核心目标**:
- 创建 `atlas-system` 服务模块，实现 `atlas-system-api` 中定义的接口
- 实现用户管理功能（查询用户信息）
- 实现角色管理功能（查询用户角色）
- 实现权限管理功能（查询用户权限）
- 使用 PostgreSQL 存储用户、角色、权限数据
- 使用 MyBatis-Plus 进行数据访问
- 使用 Flyway 或 Liquibase 管理数据库迁移脚本
- 在服务目录下建立 `sql` 目录，按版本管理 SQL 脚本

**使用场景**:
- `atlas-auth` 服务通过 Feign 接口调用 System 服务查询用户信息进行认证
- `atlas-auth` 服务通过 Feign 接口调用 System 服务查询用户权限进行授权
- Gateway 通过调用 Auth 服务验证用户权限，决定是否放行请求
- 管理员新增用户/角色/权限后，授权立即生效

**最小闭环定义**:
- 支持创建用户、角色、权限
- 支持用户与角色的关联（用户角色关系）
- 支持角色与权限的关联（角色权限关系）
- 支持查询用户信息（供 Auth 服务使用）
- 支持查询用户权限（供 Auth 服务使用）
- 数据变更后立即生效（无需重启服务）

## 用户场景

### 场景 1: Auth 服务查询用户信息进行认证

**角色**: Auth 服务

**前置条件**: 
- System 服务已启动并注册到 Nacos
- 数据库中已存在用户数据
- Auth 服务已配置 System API 的 Feign 客户端

**流程**:
1. 用户发起登录请求到 Auth 服务
2. Auth 服务通过 Feign 接口调用 System 服务查询用户信息（根据用户名）
3. System 服务从数据库查询用户信息并返回
4. Auth 服务使用返回的用户信息进行密码验证和认证

**预期结果**: Auth 服务能够成功查询到用户信息，完成用户认证

### 场景 2: Auth 服务查询用户权限进行授权

**角色**: Auth 服务

**前置条件**: 
- System 服务已启动并注册到 Nacos
- 数据库中已存在用户、角色、权限数据及关联关系
- Auth 服务已配置 System API 的 Feign 客户端

**流程**:
1. 用户已通过认证，携带 Token 访问受保护接口
2. Gateway 拦截请求，调用 Auth 服务验证 Token 和权限
3. Auth 服务通过 Feign 接口调用 System 服务查询用户权限
4. System 服务从数据库查询用户角色和权限并返回
5. Auth 服务使用返回的权限信息进行授权判断
6. Gateway 根据授权结果决定是否放行请求

**预期结果**: Auth 服务能够成功查询到用户权限，Gateway 能够正确放行或拒绝请求

### 场景 3: 管理员新增用户/角色/权限后立即生效

**角色**: 管理员

**前置条件**: 
- System 服务已启动
- 管理员已登录系统管理界面

**流程**:
1. 管理员在系统管理界面新增用户/角色/权限
2. System 服务将数据保存到数据库
3. 管理员立即使用新用户/角色/权限进行登录或访问
4. Auth 服务查询用户权限时能够获取到最新数据
5. Gateway 能够根据最新权限正确放行或拒绝请求

**预期结果**: 新增用户/角色/权限后，授权立即生效，无需重启服务

### 场景 4: 通过 Gateway 访问受保护接口

**角色**: 已认证用户

**前置条件**: 
- System 服务、Auth 服务、Gateway 都已启动
- 用户已登录并获取 Token
- 用户拥有访问目标接口的权限

**流程**:
1. 用户携带 Token 通过 Gateway 访问受保护接口
2. Gateway 拦截请求，调用 Auth 服务验证 Token
3. Auth 服务调用 System 服务查询用户权限
4. System 服务返回用户权限信息
5. Auth 服务验证用户权限，返回授权结果
6. Gateway 根据授权结果放行请求
7. 请求到达目标服务并返回结果

**预期结果**: 拥有权限的用户能够成功访问接口，无权限的用户被拒绝访问

## 功能需求

### FR1: 创建 atlas-system 服务模块

**需求描述**: 创建 `atlas-system` 服务模块，作为系统服务的实现模块。

**功能要求**:
- 创建独立的 Maven 模块 `atlas-system`
- 模块实现 `atlas-system-api` 中定义的接口
- 模块引入必要的依赖（Spring Boot Web、MyBatis-Plus、PostgreSQL、Flyway/Liquibase 等）
- 模块遵循业务模块的包结构规范（按业务再按技术分层组织）
- 模块注册到 Nacos 服务注册中心

**验收标准**:
- ✅ 模块创建成功，目录结构符合规范
- ✅ `pom.xml` 中包含必要的依赖
- ✅ 包结构符合业务模块规范（`com.atlas.system.user.controller`）
- ✅ 服务能够成功启动并注册到 Nacos

### FR2: 实现数据库设计和迁移脚本

**需求描述**: 设计用户、角色、权限的数据库表结构，并创建数据库迁移脚本。

**功能要求**:
- 设计用户表（user）：包含用户ID、用户名、密码、状态等字段
- 设计角色表（role）：包含角色ID、角色名称、角色代码等字段
- 设计权限表（permission）：包含权限ID、权限名称、权限代码等字段
- 设计用户角色关联表（user_role）：用户与角色的多对多关系
- 设计角色权限关联表（role_permission）：角色与权限的多对多关系
- 使用 Flyway 或 Liquibase 创建数据库迁移脚本
- 在服务目录下建立 `sql` 目录，按版本管理 SQL 脚本（如 `sql/v1.0.0/`）
- 每个版本子目录包含 `README.md` 说明变更内容

**验收标准**:
- ✅ 数据库表结构设计合理，支持用户/角色/权限的最小闭环
- ✅ 数据库迁移脚本创建成功，能够正确执行
- ✅ `sql` 目录结构符合规范，按版本组织
- ✅ 每个版本子目录包含 `README.md` 文件

### FR3: 实现用户实体和 Mapper

**需求描述**: 创建用户实体类和 MyBatis-Plus Mapper，实现用户数据访问。

**功能要求**:
- 创建 `User` 实体类，对应数据库用户表
- 实体类使用 MyBatis-Plus 注解（`@TableName`、`@TableId` 等）
- 创建 `UserMapper` 接口，继承 `BaseMapper<User>`
- 实现根据用户ID查询用户的方法
- 实现根据用户名查询用户的方法
- 所有类和方法添加完整的中文注释

**验收标准**:
- ✅ 实体类定义完整，字段与数据库表对应
- ✅ Mapper 接口定义完整，包含必要的查询方法
- ✅ 所有类和方法包含完整的中文注释

### FR4: 实现角色和权限实体及 Mapper

**需求描述**: 创建角色、权限实体类和 MyBatis-Plus Mapper，实现角色和权限数据访问。

**功能要求**:
- 创建 `Role` 实体类，对应数据库角色表
- 创建 `Permission` 实体类，对应数据库权限表
- 创建 `UserRole` 实体类，对应用户角色关联表
- 创建 `RolePermission` 实体类，对应角色权限关联表
- 创建对应的 Mapper 接口（`RoleMapper`、`PermissionMapper`、`UserRoleMapper`、`RolePermissionMapper`）
- 实现查询用户角色的方法
- 实现查询用户权限的方法（通过角色关联查询）
- 所有类和方法添加完整的中文注释

**验收标准**:
- ✅ 实体类定义完整，字段与数据库表对应
- ✅ Mapper 接口定义完整，包含必要的查询方法
- ✅ 能够正确查询用户角色和权限的关联关系
- ✅ 所有类和方法包含完整的中文注释

### FR5: 实现用户查询 Service

**需求描述**: 实现用户查询的 Service 层，提供用户信息查询功能。

**功能要求**:
- 创建 `UserService` 接口和实现类
- 实现根据用户ID查询用户信息的方法
- 实现根据用户名查询用户信息的方法
- Service 方法返回 `UserDTO` 对象（定义在 `atlas-system-api` 中）
- 处理用户不存在的情况，抛出适当的异常
- 所有方法添加完整的中文注释

**验收标准**:
- ✅ Service 接口和实现类定义完整
- ✅ 能够正确查询用户信息并转换为 DTO
- ✅ 用户不存在时抛出适当的异常
- ✅ 所有方法包含完整的中文注释

### FR6: 实现权限查询 Service

**需求描述**: 实现权限查询的 Service 层，提供用户权限信息查询功能。

**功能要求**:
- 创建 `PermissionService` 接口和实现类
- 实现查询用户角色列表的方法
- 实现查询用户权限列表的方法（通过角色关联查询）
- 实现查询用户完整权限信息的方法（角色+权限）
- Service 方法返回 `UserAuthoritiesDTO` 对象或 `List<String>`
- 处理用户不存在的情况，返回空列表或抛出适当的异常
- 所有方法添加完整的中文注释

**验收标准**:
- ✅ Service 接口和实现类定义完整
- ✅ 能够正确查询用户角色和权限
- ✅ 能够正确处理用户不存在的情况
- ✅ 所有方法包含完整的中文注释

### FR7: 实现用户查询 Controller

**需求描述**: 实现用户查询的 Controller 层，提供 RESTful API 接口。

**功能要求**:
- 创建 `UserController`，实现 `atlas-system-api` 中定义的 `UserQueryApi` 接口
- 实现 `GET /api/v1/users/{userId}` 接口
- 实现 `GET /api/v1/users/by-username?username={username}` 接口
- 接口返回 `Result<UserDTO>` 格式
- 接口遵循 RESTful 设计规范
- 使用统一的异常处理机制
- 所有方法添加完整的中文注释

**验收标准**:
- ✅ Controller 定义完整，实现所有必需的接口
- ✅ 接口路径符合 RESTful 规范
- ✅ 接口返回统一的数据格式
- ✅ 所有方法包含完整的中文注释

### FR8: 实现权限查询 Controller

**需求描述**: 实现权限查询的 Controller 层，提供 RESTful API 接口。

**功能要求**:
- 创建 `PermissionController`，实现 `atlas-system-api` 中定义的 `PermissionQueryApi` 接口
- 实现 `GET /api/v1/users/{userId}/roles` 接口
- 实现 `GET /api/v1/users/{userId}/permissions` 接口
- 实现 `GET /api/v1/users/{userId}/authorities` 接口
- 接口返回 `Result<List<String>>` 或 `Result<UserAuthoritiesDTO>` 格式
- 接口遵循 RESTful 设计规范
- 使用统一的异常处理机制
- 所有方法添加完整的中文注释

**验收标准**:
- ✅ Controller 定义完整，实现所有必需的接口
- ✅ 接口路径符合 RESTful 规范
- ✅ 接口返回统一的数据格式
- ✅ 所有方法包含完整的中文注释

### FR9: 实现用户/角色/权限管理功能（最小闭环）

**需求描述**: 实现用户、角色、权限的创建功能，支持最小闭环。

**功能要求**:
- 创建用户管理 Controller，提供创建用户的接口
- 创建角色管理 Controller，提供创建角色的接口
- 创建权限管理 Controller，提供创建权限的接口
- 提供用户角色关联的接口（为用户分配角色）
- 提供角色权限关联的接口（为角色分配权限）
- 所有接口遵循 RESTful 设计规范
- 所有接口返回统一的数据格式
- 数据保存到数据库后立即生效（无需缓存刷新）

**验收标准**:
- ✅ 能够创建用户、角色、权限
- ✅ 能够建立用户与角色的关联
- ✅ 能够建立角色与权限的关联
- ✅ 数据保存后立即生效，Auth 服务能够查询到最新数据

## 数据模型

### 用户表（user）

**描述**: 存储用户基本信息。

**字段定义**:

| 字段名 | 类型 | 说明 | 约束 | 示例 |
|--------|------|------|------|------|
| user_id | BIGINT | 用户ID | 主键，自增 | 1 |
| username | VARCHAR(50) | 用户名 | 唯一，非空 | "admin" |
| password | VARCHAR(255) | 密码（加密） | 非空 | "加密后的密码" |
| nickname | VARCHAR(100) | 昵称 | 可空 | "管理员" |
| email | VARCHAR(100) | 邮箱 | 可空 | "admin@example.com" |
| phone | VARCHAR(20) | 手机号 | 可空 | "13800138000" |
| status | VARCHAR(20) | 用户状态 | 非空，默认 'ACTIVE' | "ACTIVE" |
| avatar | VARCHAR(500) | 头像URL | 可空 | "https://example.com/avatar.jpg" |
| created_at | TIMESTAMP | 创建时间 | 非空 | 2025-01-06 10:00:00 |
| updated_at | TIMESTAMP | 更新时间 | 非空 | 2025-01-06 10:00:00 |

### 角色表（role）

**描述**: 存储角色信息。

**字段定义**:

| 字段名 | 类型 | 说明 | 约束 | 示例 |
|--------|------|------|------|------|
| role_id | BIGINT | 角色ID | 主键，自增 | 1 |
| role_code | VARCHAR(50) | 角色代码 | 唯一，非空 | "ADMIN" |
| role_name | VARCHAR(100) | 角色名称 | 非空 | "管理员" |
| description | VARCHAR(500) | 角色描述 | 可空 | "系统管理员" |
| status | VARCHAR(20) | 角色状态 | 非空，默认 'ACTIVE' | "ACTIVE" |
| created_at | TIMESTAMP | 创建时间 | 非空 | 2025-01-06 10:00:00 |
| updated_at | TIMESTAMP | 更新时间 | 非空 | 2025-01-06 10:00:00 |

### 权限表（permission）

**描述**: 存储权限信息。

**字段定义**:

| 字段名 | 类型 | 说明 | 约束 | 示例 |
|--------|------|------|------|------|
| permission_id | BIGINT | 权限ID | 主键，自增 | 1 |
| permission_code | VARCHAR(100) | 权限代码 | 唯一，非空 | "user:read" |
| permission_name | VARCHAR(100) | 权限名称 | 非空 | "用户查询" |
| description | VARCHAR(500) | 权限描述 | 可空 | "查询用户信息" |
| status | VARCHAR(20) | 权限状态 | 非空，默认 'ACTIVE' | "ACTIVE" |
| created_at | TIMESTAMP | 创建时间 | 非空 | 2025-01-06 10:00:00 |
| updated_at | TIMESTAMP | 更新时间 | 非空 | 2025-01-06 10:00:00 |

### 用户角色关联表（user_role）

**描述**: 存储用户与角色的关联关系。

**字段定义**:

| 字段名 | 类型 | 说明 | 约束 | 示例 |
|--------|------|------|------|------|
| id | BIGINT | 关联ID | 主键，自增 | 1 |
| user_id | BIGINT | 用户ID | 外键，非空 | 1 |
| role_id | BIGINT | 角色ID | 外键，非空 | 1 |
| created_at | TIMESTAMP | 创建时间 | 非空 | 2025-01-06 10:00:00 |

### 角色权限关联表（role_permission）

**描述**: 存储角色与权限的关联关系。

**字段定义**:

| 字段名 | 类型 | 说明 | 约束 | 示例 |
|--------|------|------|------|------|
| id | BIGINT | 关联ID | 主键，自增 | 1 |
| role_id | BIGINT | 角色ID | 外键，非空 | 1 |
| permission_id | BIGINT | 权限ID | 外键，非空 | 1 |
| created_at | TIMESTAMP | 创建时间 | 非空 | 2025-01-06 10:00:00 |

## 业务逻辑

### 用户查询流程

**核心流程**:
1. Controller 接收查询请求（用户ID或用户名）
2. Controller 调用 Service 层查询用户信息
3. Service 层调用 Mapper 查询数据库
4. Mapper 返回实体对象
5. Service 层将实体对象转换为 DTO
6. Controller 返回 `Result<UserDTO>`

**异常处理**:
- 用户不存在：返回错误码，data 为 null
- 参数错误：返回参数错误码，data 为 null

### 权限查询流程

**核心流程**:
1. Controller 接收查询请求（用户ID）
2. Controller 调用 Service 层查询用户权限
3. Service 层查询用户角色关联表，获取用户角色列表
4. Service 层根据角色列表查询角色权限关联表，获取权限列表
5. Service 层合并权限列表（去重）
6. Service 层将数据转换为 DTO
7. Controller 返回 `Result<UserAuthoritiesDTO>`

**异常处理**:
- 用户不存在：返回空列表或错误码
- 用户无角色：返回空列表
- 角色无权限：返回空列表

### 数据变更立即生效

**核心原则**:
- 数据直接保存到数据库，不依赖缓存
- Auth 服务每次查询都从数据库获取最新数据
- 无需手动刷新缓存或重启服务

**实现方式**:
- Service 层直接操作数据库，不使用缓存
- 查询方法每次都从数据库查询最新数据
- 确保数据一致性

## 异常处理

### 业务异常

**异常场景**:
- 用户不存在：返回错误码 `032001`，message 为 "用户不存在"
- 角色不存在：返回错误码 `032002`，message 为 "角色不存在"
- 权限不存在：返回错误码 `032003`，message 为 "权限不存在"
- 参数错误：返回错误码 `013001`，message 为 "参数错误"

**错误码规范**:
- 使用 `atlas-common-feature-core` 模块的 `CommonErrorCode` 常量
- 系统域错误码：03 开头
- 用户相关错误：032001-032099
- 角色相关错误：032101-032199
- 权限相关错误：032201-032299

### 系统异常

**异常场景**:
- 数据库连接失败：返回错误码 `050001`，message 为 "系统错误"
- 服务不可用：返回错误码 `050002`，message 为 "服务不可用"

**处理方式**:
- 使用统一的异常处理机制（`@ControllerAdvice`）
- 记录异常日志，便于问题排查
- 返回用户友好的错误消息

## 测试要求

### 单元测试

- Service 层单元测试覆盖率 ≥ 70%
- Mapper 层单元测试（使用 MyBatis-Plus 测试工具）
- 实体类序列化/反序列化测试

### 集成测试

- Controller 层集成测试（使用 MockMvc）
- Service 层与 Mapper 层集成测试
- 数据库操作集成测试

### API 测试

- 用户查询接口测试
- 权限查询接口测试
- 用户/角色/权限创建接口测试
- 关联关系接口测试

### 验收测试

- Auth 服务能够成功查询用户信息
- Auth 服务能够成功查询用户权限
- 新增用户/角色/权限后，授权立即生效
- 通过 Gateway 访问受保护接口能正确放行/拒绝

## 成功标准

成功标准用于衡量功能是否达到预期目标，这些标准是可测量的、技术无关的，从用户和业务角度描述结果。

### 功能完整性

1. **接口实现完整**: 所有 `atlas-system-api` 中定义的接口都已实现，接口功能正常
2. **数据管理完整**: 支持用户、角色、权限的创建和关联，形成最小闭环
3. **查询功能完整**: 支持用户信息查询和权限查询，满足 Auth 服务需求

### 数据一致性

1. **数据实时生效**: 新增用户/角色/权限后，Auth 服务能够立即查询到最新数据
2. **关联关系正确**: 用户角色关联和角色权限关联关系正确，权限查询结果准确
3. **数据完整性**: 数据库表结构设计合理，支持完整的数据关系

### 系统集成

1. **服务可调用**: Auth 服务能够通过 Feign 接口成功调用 System 服务
2. **授权正确**: Gateway 通过 Auth 服务验证权限后，能够正确放行或拒绝请求
3. **端到端可用**: 从用户登录到访问受保护接口的完整流程能够正常工作

### 开发质量

1. **代码规范**: 所有代码遵循项目规范，包含完整的中文注释
2. **测试覆盖**: 单元测试和集成测试覆盖主要功能，测试通过率 100%
3. **文档完整**: 数据库迁移脚本和 SQL 目录文档完整，便于维护

## 验收标准

### 功能验收

1. **服务启动**: System 服务能够成功启动并注册到 Nacos
2. **接口实现**: 所有 `atlas-system-api` 中定义的接口都已实现
3. **数据管理**: 能够创建用户、角色、权限及关联关系
4. **查询功能**: 能够正确查询用户信息和权限信息

### 集成验收

1. **Auth 集成**: Auth 服务能够成功调用 System 服务查询用户和权限
2. **Gateway 集成**: Gateway 能够通过 Auth 服务验证权限，正确放行或拒绝请求
3. **实时生效**: 新增用户/角色/权限后，授权立即生效，无需重启服务

### 技术验收

1. **数据库**: 使用 PostgreSQL 数据库，表结构设计合理
2. **数据访问**: 使用 MyBatis-Plus 进行数据访问，代码规范
3. **迁移脚本**: 使用 Flyway 或 Liquibase 管理数据库迁移脚本
4. **SQL 目录**: 在服务目录下建立 `sql` 目录，按版本管理 SQL 脚本
5. **包结构**: 包结构符合业务模块规范（按业务再按技术分层组织）

## 实现注意事项

- [ ] 确保所有类和方法添加中文注释
- [ ] 遵循 RESTful 设计规范
- [ ] 使用统一的异常处理机制
- [ ] 使用 MyBatis-Plus 进行数据访问
- [ ] 使用 Flyway 或 Liquibase 管理数据库迁移脚本
- [ ] 在服务目录下建立 `sql` 目录，按版本管理 SQL 脚本
- [ ] 确保数据变更后立即生效，不依赖缓存
- [ ] 检查是否有可复用的公共方法
- [ ] 确保包结构符合业务模块规范
