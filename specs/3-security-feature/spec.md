# 功能规格说明

## 宪法检查

本规格说明必须符合项目宪法要求：

- ✅ **模块化**: 功能归属 `atlas-common-feature-security` 模块
- ✅ **代码复用**: 提供可复用的安全相关类和接口
- ✅ **中文注释**: 所有代码使用中文注释
- ✅ **抽象设计**: 先定义抽象接口，不绑定具体实现

## 功能描述

实现 `atlas-common-feature-security` 模块，提供项目安全功能特性，包括登录用户信息模型（LoginUser）、权限注解定义、以及安全上下文获取接口。该模块采用抽象设计，定义接口和注解，不绑定具体实现，为业务模块提供统一的安全功能抽象，支持多种安全实现方案的灵活切换。

## 功能需求

### FR1: 登录用户信息模型 LoginUser

**需求描述**: 提供登录用户信息的数据模型，封装当前登录用户的基本信息和权限信息。

**功能要求**:
- 定义 LoginUser 接口或抽象类，包含用户基本信息（用户ID、用户名、角色等）
- 包含用户权限信息（权限列表、角色列表等）
- 支持扩展，允许业务模块添加自定义字段
- 提供便捷的访问方法获取用户信息
- 所有字段和方法包含中文注释

**验收标准**:
- LoginUser 可以表示完整的用户身份信息
- 可以获取用户的基本信息（ID、用户名等）
- 可以获取用户的权限和角色信息
- 支持业务模块扩展自定义字段
- 所有方法都有中文注释说明

### FR2: 权限注解定义

**需求描述**: 提供权限相关的注解，用于在方法或类上声明权限要求。

**功能要求**:
- 定义权限检查注解（如 @RequiresPermission、@RequiresRole 等）
- 注解支持单个权限或多个权限的声明
- 注解支持角色检查
- 注解可以应用于类级别和方法级别
- 注解包含中文注释说明使用方式
- 注解定义不包含具体实现逻辑，仅作为元数据标记

**验收标准**:
- 可以通过注解声明方法或类的权限要求
- 注解支持单个或多个权限值
- 注解支持角色检查
- 注解可以应用于类和方法
- 注解定义清晰，包含完整的中文注释
- 注解不包含实现逻辑，仅作为标记

### FR3: 安全上下文获取接口

**需求描述**: 提供安全上下文获取的抽象接口，用于获取当前登录用户信息和安全上下文。

**功能要求**:
- 定义 SecurityContext 接口，提供获取当前登录用户的方法
- 定义 SecurityContextHolder 抽象类或接口，提供静态方法获取安全上下文
- 接口方法返回 LoginUser 对象
- 支持判断当前是否有登录用户
- 接口定义不绑定具体实现，允许不同实现方案
- 所有接口和方法包含中文注释

**验收标准**:
- 可以通过接口获取当前登录用户信息
- 可以判断当前是否存在登录用户
- 接口设计支持多种实现方案
- 接口定义清晰，不包含实现细节
- 所有接口和方法都有中文注释说明

## 用户场景

### 场景 1: 开发人员在 Controller 方法中获取当前登录用户

**角色**: 后端开发人员

**前置条件**: 开发人员正在实现需要获取当前用户信息的接口

**操作流程**:
1. 开发人员在 Controller 方法中调用 SecurityContextHolder 的方法
2. 获取当前登录的 LoginUser 对象
3. 从 LoginUser 中提取用户ID或其他信息
4. 使用用户信息进行业务处理

**预期结果**: 开发人员可以方便地获取当前登录用户信息，无需关心底层实现细节

### 场景 2: 开发人员使用权限注解保护接口

**角色**: 后端开发人员

**前置条件**: 开发人员需要为接口添加权限控制

**操作流程**:
1. 开发人员在 Controller 方法或类上添加权限注解
2. 在注解中声明所需的权限或角色
3. 权限检查框架（后续实现）根据注解进行权限验证

**预期结果**: 接口被正确标记权限要求，权限检查框架可以根据注解进行权限验证

### 场景 3: 开发人员扩展 LoginUser 添加业务字段

**角色**: 后端开发人员

**前置条件**: 业务模块需要存储额外的用户信息

**操作流程**:
1. 开发人员创建业务特定的 LoginUser 实现类
2. 扩展 LoginUser 接口，添加业务字段
3. 实现所有必需的方法
4. 在安全上下文实现中使用扩展的 LoginUser

**预期结果**: 业务模块可以灵活扩展用户信息模型，满足特定业务需求

### 场景 4: 系统集成不同的安全实现方案

**角色**: 系统架构师

**前置条件**: 系统需要支持不同的认证授权方案（如 JWT、Session、OAuth2 等）

**操作流程**:
1. 架构师基于抽象接口实现具体的安全上下文提供者
2. 实现 SecurityContext 接口的具体类
3. 实现 SecurityContextHolder 的具体逻辑
4. 业务代码无需修改，自动使用新的实现

**预期结果**: 系统可以灵活切换不同的安全实现方案，业务代码保持稳定

## 数据模型

### LoginUser（接口）

| 方法名 | 返回类型 | 说明 | 必填 |
|--------|----------|------|------|
| getUserId | String/Long | 获取用户ID | 是 |
| getUsername | String | 获取用户名 | 是 |
| getRoles | List<String> | 获取用户角色列表 | 是 |
| getPermissions | List<String> | 获取用户权限列表 | 是 |
| hasRole | boolean | 判断是否拥有指定角色 | 是 |
| hasPermission | boolean | 判断是否拥有指定权限 | 是 |

### SecurityContext（接口）

| 方法名 | 返回类型 | 说明 | 必填 |
|--------|----------|------|------|
| getLoginUser | LoginUser | 获取当前登录用户 | 是 |
| isAuthenticated | boolean | 判断当前是否已认证 | 是 |
| clear | void | 清除当前安全上下文 | 否 |

### SecurityContextHolder（抽象类/工具类）

| 方法名 | 返回类型 | 说明 | 必填 |
|--------|----------|------|------|
| getContext | SecurityContext | 获取当前安全上下文（静态方法） | 是 |
| getLoginUser | LoginUser | 获取当前登录用户（静态方法） | 是 |
| isAuthenticated | boolean | 判断当前是否已认证（静态方法） | 是 |

### @RequiresPermission（注解）

| 属性名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| value | String[] | 所需的权限列表 | 是 |
| logical | Logical | 权限之间的逻辑关系（AND/OR） | 否 |

### @RequiresRole（注解）

| 属性名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| value | String[] | 所需的角色列表 | 是 |
| logical | Logical | 角色之间的逻辑关系（AND/OR） | 否 |

## 业务逻辑

### 安全上下文获取逻辑

1. **获取当前用户**:
   - 通过 SecurityContextHolder.getLoginUser() 获取当前登录用户
   - 如果未登录，返回 null 或抛出异常（具体行为由实现决定）

2. **权限判断**:
   - 通过 LoginUser.hasPermission() 判断用户是否拥有指定权限
   - 通过 LoginUser.hasRole() 判断用户是否拥有指定角色

3. **上下文管理**:
   - 安全上下文由具体实现负责设置和清除
   - 抽象接口不定义设置方法，由实现类自行管理

### 权限注解处理逻辑

1. **注解扫描**:
   - 权限检查框架（后续实现）扫描类和方法上的权限注解
   - 提取注解中的权限或角色要求

2. **权限验证**:
   - 获取当前登录用户
   - 根据注解要求验证用户权限或角色
   - 验证失败时拒绝访问（具体行为由实现决定）

## 异常处理

### 异常类型

1. **未认证异常**: 当前用户未登录时访问需要认证的资源
2. **权限不足异常**: 当前用户权限不足时访问受保护资源

### 异常处理策略

- 异常定义在抽象层，不包含具体实现
- 具体实现可以定义自己的异常类
- 异常信息包含中文错误消息

## 测试要求

- 单元测试覆盖率 ≥ 80%
- 测试 LoginUser 接口的所有方法
- 测试 SecurityContext 接口的所有方法
- 测试 SecurityContextHolder 的工具方法
- 测试权限注解的定义和属性

## 成功标准

1. **抽象性**: 所有接口和注解定义清晰，不包含实现细节，抽象性达到 100%
2. **可扩展性**: 业务模块可以在 15 分钟内基于抽象接口实现自定义的安全上下文
3. **易用性**: 开发人员可以在 10 分钟内理解并使用 LoginUser 和权限注解
4. **完整性**: 所有功能需求实现完成，单元测试覆盖率 ≥ 80%
5. **规范性**: 所有代码符合项目规范，中文注释覆盖率 100%

## 依赖关系

### 内部依赖

- 依赖父 POM（atlas）的版本管理
- 依赖 `atlas-common-feature-core` 模块的异常体系（可选）

### 外部依赖

- 无强制外部依赖（保持抽象层的纯净性）
- 具体实现可以引入所需的安全框架（如 Spring Security、Shiro 等）

## 假设

1. 具体的安全实现会在其他模块中完成
2. 权限检查框架会在后续实现中基于这些抽象接口开发
3. 业务模块会基于这些抽象接口进行开发
4. 不同的安全实现方案都会实现相同的抽象接口
5. 用户信息和权限信息会在认证阶段设置到安全上下文中

## 实现注意事项

- [ ] 确保所有接口和注解都是抽象的，不包含实现细节
- [ ] 确保 LoginUser 接口设计支持扩展
- [ ] 确保权限注解支持灵活的权限组合（AND/OR）
- [ ] 确保 SecurityContextHolder 设计支持多种实现方案
- [ ] 确保所有类和方法添加中文注释
- [ ] 遵循包名规范：`com.atlas.common.feature.security`
- [ ] 不引入具体的安全框架依赖，保持抽象层的独立性

